<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crave Lush | Sabor que Seduce</title>
    
    <!-- Librer√≠as -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --purple: #6f2c91;
            --yellow: #ffb800;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.2);
            --transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; }

        body { 
            background: linear-gradient(-45deg, #6f2c91, #ffb800, #4a1a63, #e6a600);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #333; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- ELEMENTOS 3D FLOTANTES --- */
        .bg-icons { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; overflow: hidden; }
        .floating-cone { position: absolute; color: rgba(255,255,255,0.2); font-size: 3rem; animation: float 10s infinite linear; }
        @keyframes float {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        /* --- HEADER RESPONSIVE --- */
        header.main-nav {
            position: fixed; top: 0; width: 100%;
            background: rgba(111, 44, 145, 0.9);
            backdrop-filter: blur(15px);
            padding: 10px 5%;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 3000; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .logo-container { display: flex; align-items: center; gap: 12px; }
        #app-logo { height: 45px; width: auto; border-radius: 8px; }
        .logo h2 { color: var(--yellow); font-size: 1.4rem; font-weight: 700; }

        .nav-links { display: flex; gap: 15px; }
        .burger { display: none; color: white; font-size: 1.8rem; cursor: pointer; }

        .btn-nav {
            background: var(--yellow); color: var(--purple);
            border: none; padding: 10px 20px; border-radius: 50px;
            font-weight: 700; cursor: pointer; transition: var(--transition);
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .btn-nav:hover { transform: translateY(-3px); background: white; box-shadow: var(--shadow); }

        /* --- SECCIONES --- */
        .section { display: none; padding: 30px 5%; max-width: 1200px; margin: 90px auto 0; animation: slideUp 0.6s ease; }
        .section.active { display: block; }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .admin-box { background: rgba(255,255,255,0.95); padding: 25px; border-radius: 25px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.3); }
        input, select, textarea { width: 100%; padding: 14px; margin: 8px 0; border: 2px solid #eee; border-radius: 15px; outline: none; font-size: 1rem; }
        h4 { color: var(--purple); margin-bottom: 15px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }

        /* BOTONES CONTORNO */
        .contour-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; margin: 15px 0; }
        .btn-contour {
            padding: 12px; border: 2px solid var(--purple); border-radius: 18px;
            background: transparent; color: var(--purple); font-weight: 700;
            cursor: pointer; transition: 0.3s; text-align: center;
        }
        .btn-contour.active { background: var(--purple); color: white; transform: scale(1.05); box-shadow: var(--shadow); }

        /* LOGIN EST√âTICO */
        .login-card {
            max-width: 400px; margin: 50px auto; background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px); padding: 40px; border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.4); text-align: center; color: white;
        }
        .login-card input { background: rgba(255,255,255,0.9); border: none; text-align: center; font-size: 1.2rem; }

        /* TABLAS Y VENTAS */
        .inv-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .inv-table th { background: var(--purple); color: white; padding: 12px; text-align: left; }
        .inv-table td { padding: 12px; border-bottom: 1px solid #ddd; }
        .stock-low { color: #ff0000; font-weight: bold; background: rgba(255,0,0,0.05); }

        #cart-btn {
            position: fixed; bottom: 25px; right: 25px;
            background: var(--yellow); color: var(--purple);
            width: 70px; height: 70px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; cursor: pointer; z-index: 2000; box-shadow: var(--shadow);
            border: 4px solid var(--purple);
        }

        /* RESPONSIVE MOBILE */
        @media (max-width: 768px) {
            .nav-links {
                position: fixed; top: 0; right: -100%; width: 70%; height: 100vh;
                background: var(--purple); flex-direction: column; padding: 80px 20px;
                transition: 0.5s; box-shadow: -5px 0 20px rgba(0,0,0,0.3);
            }
            .nav-links.active { right: 0; }
            .burger { display: block; }
            .btn-nav { width: 100%; justify-content: center; padding: 15px; font-size: 1.1rem; }
            .logo h2 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

    <div class="bg-icons" id="bg-icons"></div>

    <header class="main-nav">
        <div class="logo-container">
            <img id="app-logo" src="https://cdn-icons-png.flaticon.com/512/938/938063.png" alt="Logo">
            <div class="logo"><h2>CRAVE <span>LUSH</span></h2></div>
        </div>
        <div class="burger" onclick="toggleMenu()"><i class="fas fa-bars"></i></div>
        <div class="nav-links" id="nav-menu">
            <button class="btn-nav" onclick="switchView('view-menu')"><i class="fas fa-ice-cream"></i> <span>MEN√ö</span></button>
            <button class="btn-nav" onclick="showLogin('kitchen')"><i class="fas fa-fire"></i> <span>COCINA</span></button>
            <button class="btn-nav" onclick="showLogin('admin')"><i class="fas fa-user-shield"></i> <span>ADMIN</span></button>
        </div>
    </header>

    <main>
        <!-- MEN√ö -->
        <section id="view-menu" class="section active">
            <div id="menu-container" class="menu-grid"></div>
        </section>

        <!-- COCINA -->
        <section id="view-kitchen" class="section">
            <h4><i class="fas fa-utensils"></i> PEDIDOS PENDIENTES</h4>
            <div id="kitchen-orders"></div>
            <div class="admin-box">
                <h4><i class="fas fa-box-open"></i> GESTI√ìN R√ÅPIDA DE INVENTARIO</h4>
                <div id="kitchen-inventory-list"></div>
            </div>
        </section>

        <!-- ADMIN -->
        <section id="view-admin" class="section">
            <!-- Ventas del D√≠a -->
            <div class="admin-box" style="background: var(--purple); color: white;">
                <h4 style="color: var(--yellow);"><i class="fas fa-chart-line"></i> RESUMEN DE VENTAS (HOY)</h4>
                <div style="font-size: 2rem; font-weight: 700;">$<span id="total-sales">0.00</span></div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-nav" onclick="exportSalesExcel()" style="background: #28a745; color: white; border: none;">
                        <i class="fas fa-file-excel"></i> EXCEL VENTAS
                    </button>
                    <button class="btn-nav" onclick="shareSalesWhatsApp()" style="background: #25D366; color: white; border: none;">
                        <i class="fab fa-whatsapp"></i> COMPARTIR
                    </button>
                </div>
            </div>

            <div class="admin-box">
                <h4><i class="fas fa-plus-circle"></i> NUEVO PRODUCTO</h4>
                <input type="text" id="prod-name" placeholder="Nombre del producto">
                <input type="number" id="prod-price" placeholder="Precio ($)">
                <div id="contour-inputs">
                    <input type="text" class="contour-opt" placeholder="Contorno 1 (Ej: Chocolate)">
                </div>
                <button onclick="addContourField()" style="background:none; border:none; color:var(--purple); cursor:pointer; font-weight:bold;">+ A√±adir otro campo de contorno</button>
                <input type="file" id="prod-img">
                <button class="btn-nav" onclick="uploadProduct()" style="width:100%; justify-content:center; margin-top:15px;">GUARDAR EN MEN√ö</button>
            </div>

            <div class="admin-box">
                <h4><i class="fas fa-warehouse"></i> INVENTARIO & GASTOS</h4>
                <button class="btn-nav" onclick="exportInventoryExcel()" style="background: #217346; color: white; margin-bottom: 15px; width: 100%; justify-content: center;">
                    <i class="fas fa-download"></i> DESCARGAR REPORTE GASTOS
                </button>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <input type="text" id="inv-name" placeholder="Material">
                    <input type="number" id="inv-qty" placeholder="Stock">
                    <input type="number" id="inv-cost" placeholder="Costo $">
                </div>
                <button class="btn-nav" onclick="addInventory()" style="width:100%; justify-content:center;">ACTUALIZAR INVENTARIO</button>
                <table class="inv-table" id="admin-inventory-table">
                    <thead><tr><th>Material</th><th>Stock</th><th>Costo</th><th>Acciones</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- PANTALLA LOGIN -->
        <section id="view-login" class="section">
            <div class="login-card">
                <i class="fas fa-lock" style="font-size: 3rem; margin-bottom: 20px; color: var(--yellow);"></i>
                <h2 id="login-title">ACCESO RESTRINGIDO</h2>
                <p id="login-desc" style="margin-bottom: 20px; opacity: 0.8;"></p>
                <input type="password" id="pass-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button class="btn-nav" onclick="attemptLogin()" style="width:100%; justify-content:center; margin-top:20px;">ENTRAR</button>
                <button onclick="switchView('view-menu')" style="background:none; border:none; color:white; margin-top:15px; cursor:pointer;">Cancelar</button>
            </div>
        </section>
    </main>

    <!-- MODAL DETALLE PRODUCTO -->
    <div id="product-modal" class="modal-overlay" onclick="closeModals(event)">
        <div class="modal-content">
            <h3 id="modal-prod-name" style="color:var(--purple); font-size:1.8rem;"></h3>
            <p style="margin:10px 0; font-weight:bold;">Elige tus extras:</p>
            <div id="contour-container" class="contour-grid"></div>
            <button class="btn-nav" style="width:100%; justify-content:center; margin-top:20px;" onclick="confirmAddToCart()">A√ëADIR AL CARRITO üç¶</button>
        </div>
    </div>

    <!-- MODAL CARRITO -->
    <div id="cart-modal" class="modal-overlay" onclick="closeModals(event)">
        <div class="modal-content">
            <h3>üõí Tu Carrito</h3>
            <div id="cart-list"></div>
            <hr>
            <h4 style="margin: 15px 0;">Total: $<span id="cart-total">0.00</span></h4>
            <select id="client-pay-method">
                <option value="Efectivo">üíµ Efectivo</option>
                <option value="Pago M√≥vil">üì± Pago M√≥vil</option>
                <option value="Transferencia">üè¶ Transferencia</option>
            </select>
            <input type="text" id="client-name" placeholder="¬øA nombre de qui√©n?">
            <button class="btn-nav" style="width:100%; justify-content:center;" onclick="sendOrder()">ENVIAR A COCINA</button>
        </div>
    </div>

    <div id="cart-btn" onclick="openCart()">
        <i class="fas fa-shopping-basket"></i>
        <span id="cart-count" style="position:absolute; top:5px; right:5px; background:white; color:var(--purple); border-radius:50%; width:22px; height:22px; font-size:0.8rem; display:flex; align-items:center; justify-content:center; font-weight:bold;">0</span>
    </div>

    <script>
        // CONFIGURACI√ìN FIREBASE (Mant√©n tu config original)
        const firebaseConfig = {
            apiKey: "AIzaSyDrNGtxwj0sijnq_vBCTyiRVLO28_D9JG0",
            authDomain: "cravelush-e3277.firebaseapp.com",
            projectId: "cravelush-e3277",
            databaseURL: "https://cravelush-e3277-default-rtdb.firebaseio.com",
            storageBucket: "cravelush-e3277.appspot.com",
            appId: "1:306682994312:web:c7b4e4c7911b2ccaaa493d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let cart = [];
        let selectedProduct = null;
        let selectedContour = "B√°sico";
        let targetRole = "";

        // UI ANIMATIONS
        function createFloatingIcons() {
            const container = document.getElementById('bg-icons');
            const icons = ['fa-ice-cream', 'fa-cookie', 'fa-candy-cane'];
            for(let i=0; i<15; i++) {
                const el = document.createElement('i');
                el.className = `fas ${icons[Math.floor(Math.random()*icons.length)]} floating-cone`;
                el.style.left = Math.random() * 100 + 'vw';
                el.style.animationDelay = Math.random() * 5 + 's';
                el.style.fontSize = (Math.random() * 2 + 1) + 'rem';
                container.appendChild(el);
            }
        }
        createFloatingIcons();

        function toggleMenu() { document.getElementById('nav-menu').classList.toggle('active'); }

        function switchView(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('nav-menu').classList.remove('active');
            window.scrollTo(0,0);
        }

        // LOGIN SYSTEM
        function showLogin(role) {
            targetRole = role;
            document.getElementById('login-title').innerText = "ACCESO " + role.toUpperCase();
            document.getElementById('login-desc').innerText = "Introduce la clave de seguridad para continuar.";
            document.getElementById('pass-input').value = "";
            switchView('view-login');
        }

        function attemptLogin() {
            const pass = document.getElementById('pass-input').value;
            const keys = { admin: "1234", kitchen: "5555" };
            if(pass === keys[targetRole]) switchView('view-' + targetRole);
            else alert("¬°Clave incorrecta!");
        }

        // ADMIN: CONTOURN FIELDS
        function addContourField() {
            const input = document.createElement('input');
            input.type = "text";
            input.className = "contour-opt";
            input.placeholder = "Otro contorno...";
            document.getElementById('contour-inputs').appendChild(input);
        }

        // PRODUCTOS
        function uploadProduct() {
            const name = document.getElementById('prod-name').value;
            const price = parseFloat(document.getElementById('prod-price').value);
            const contourInputs = document.querySelectorAll('.contour-opt');
            const contours = Array.from(contourInputs).map(i => i.value).filter(v => v !== "").join(",");
            const file = document.getElementById('prod-img').files[0];
            if(!name || isNaN(price) || !file) return alert("Completa todos los campos");

            const reader = new FileReader();
            reader.onload = (e) => {
                db.ref('products').push({ name, price, contours, img: e.target.result });
                alert("¬°Producto a√±adido con √©xito!");
                location.reload();
            };
            reader.readAsDataURL(file);
        }

        db.ref('products').on('value', snap => {
            const container = document.getElementById('menu-container');
            container.innerHTML = "";
            snap.forEach(child => {
                const p = child.val();
                container.innerHTML += `
                    <div class="card" style="background:white; border-radius:25px; overflow:hidden; box-shadow:var(--shadow);">
                        <img src="${p.img}" style="width:100%; height:200px; object-fit:cover;">
                        <div style="padding:20px; text-align:center;">
                            <h3 style="color:var(--purple);">${p.name}</h3>
                            <p style="font-weight:700; font-size:1.3rem; margin:10px 0;">$${p.price.toFixed(2)}</p>
                            <button class="btn-nav" style="width:100%; justify-content:center;" 
                                onclick="openProductDetail('${p.name}', ${p.price}, '${p.contours}')">PEDIR AHORA</button>
                        </div>
                    </div>
                `;
            });
        });

        function openProductDetail(name, price, contours) {
            selectedProduct = { name, price };
            selectedContour = "B√°sico";
            document.getElementById('modal-prod-name').innerText = name;
            const container = document.getElementById('contour-container');
            container.innerHTML = `<button class="btn-contour active" onclick="selectContour(this, 'B√°sico')">B√°sico</button>`;
            if(contours) {
                contours.split(',').forEach(c => {
                    container.innerHTML += `<button class="btn-contour" onclick="selectContour(this, '${c.trim()}')">${c.trim()}</button>`;
                });
            }
            document.getElementById('product-modal').style.display = 'flex';
        }

        function selectContour(btn, val) {
            document.querySelectorAll('.btn-contour').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedContour = val;
        }

        function confirmAddToCart() {
            cart.push({ ...selectedProduct, contour: selectedContour });
            document.getElementById('cart-count').innerText = cart.length;
            document.getElementById('product-modal').style.display = 'none';
        }

        // CARRITO Y ORDENES
        function openCart() {
            if(cart.length === 0) return alert("El carrito est√° vac√≠o");
            const list = document.getElementById('cart-list');
            let total = 0; list.innerHTML = "";
            cart.forEach((item, index) => {
                total += item.price;
                list.innerHTML += `<div style="display:flex; justify-content:space-between; margin:8px 0;">
                    <span>${item.name} (${item.contour})</span> <b>$${item.price.toFixed(2)}</b>
                </div>`;
            });
            document.getElementById('cart-total').innerText = total.toFixed(2);
            document.getElementById('cart-modal').style.display = 'flex';
        }

        function sendOrder() {
            const name = document.getElementById('client-name').value;
            if(!name) return alert("Escribe tu nombre");
            const order = {
                client: name,
                items: cart.map(i => `${i.name} [${i.contour}]`).join(", "),
                total: parseFloat(document.getElementById('cart-total').innerText),
                method: document.getElementById('client-pay-method').value,
                time: new Date().toLocaleString()
            };
            db.ref('orders').push(order);
            alert("¬°Pedido enviado! Preparando tu delicia...");
            cart = [];
            document.getElementById('cart-count').innerText = "0";
            document.getElementById('cart-modal').style.display = 'none';
        }

        // COCINA Y VENTAS
        db.ref('orders').on('value', snap => {
            const container = document.getElementById('kitchen-orders');
            container.innerHTML = "";
            snap.forEach(child => {
                const o = child.val();
                container.innerHTML += `
                    <div class="admin-box" style="border-left: 10px solid var(--yellow);">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <b style="font-size:1.2rem;">${o.client}</b><br>
                                <small>${o.time}</small>
                            </div>
                            <span style="background:var(--purple); color:white; padding:5px 10px; border-radius:10px; font-size:0.8rem;">${o.method}</span>
                        </div>
                        <p style="margin:15px 0; font-size:1.1rem; color:#444;">${o.items}</p>
                        <button class="btn-nav" style="width:100%; justify-content:center; background:#28a745; color:white;" 
                            onclick="completeOrder('${child.key}')">MARCAR COMO LISTO ‚úÖ</button>
                    </div>
                `;
            });
        });

        function completeOrder(key) {
            db.ref('orders/' + key).once('value', snap => {
                const data = snap.val();
                db.ref('sales_history').push(data); // Mueve a historial de ventas
                db.ref('orders/' + key).remove();
            });
        }

        // DASHBOARD VENTAS
        db.ref('sales_history').on('value', snap => {
            let total = 0;
            snap.forEach(child => {
                const sale = child.val();
                // Opcional: Filtrar solo las de hoy
                total += parseFloat(sale.total);
            });
            document.getElementById('total-sales').innerText = total.toFixed(2);
        });

        // EXPORTACI√ìN EXCEL
        function exportSalesExcel() {
            db.ref('sales_history').once('value', snap => {
                let csv = "Fecha,Cliente,Pedido,Metodo,Total\n";
                snap.forEach(child => {
                    const s = child.val();
                    csv += `"${s.time}","${s.client}","${s.items}","${s.method}","${s.total}"\n`;
                });
                downloadCSV(csv, "Ventas_CraveLush.csv");
            });
        }

        function exportInventoryExcel() {
            db.ref('inventory').once('value', snap => {
                let csv = "Material,Cantidad,Costo Invertido\n";
                snap.forEach(child => {
                    const i = child.val();
                    csv += `"${i.name}","${i.qty}","${i.cost}"\n`;
                });
                downloadCSV(csv, "Inventario_CraveLush.csv");
            });
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", filename);
            link.click();
        }

        // WHATSAPP SHARE
        function shareSalesWhatsApp() {
            const total = document.getElementById('total-sales').innerText;
            const text = encodeURIComponent(`üìä *REPORTE CRAVE LUSH*\nVentas Totales: $${total}\n¬°Buen trabajo equipo! üç¶`);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        // INVENTARIO
        function addInventory() {
            const name = document.getElementById('inv-name').value;
            const qty = document.getElementById('inv-qty').value;
            const cost = document.getElementById('inv-cost').value;
            if(!name || !qty) return;
            db.ref('inventory').push({ name, qty, cost });
            document.getElementById('inv-name').value = "";
            document.getElementById('inv-qty').value = "";
            document.getElementById('inv-cost').value = "";
        }

        db.ref('inventory').on('value', snap => {
            const tbody = document.querySelector('#admin-inventory-table tbody');
            const kitchenList = document.getElementById('kitchen-inventory-list');
            tbody.innerHTML = ""; kitchenList.innerHTML = "";
            snap.forEach(child => {
                const i = child.val();
                const low = i.qty < 5 ? 'stock-low' : '';
                tbody.innerHTML += `<tr class="${low}">
                    <td>${i.name}</td><td>${i.qty}</td><td>$${i.cost || 0}</td>
                    <td><button onclick="db.ref('inventory/${child.key}').remove()">X</button></td>
                </tr>`;
                kitchenList.innerHTML += `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; padding:10px; background:#f4f4f4; border-radius:10px;">
                        <span>${i.name} (Stock: ${i.qty})</span>
                        <button onclick="reduceStock('${child.key}', ${i.qty})" style="padding:2px 10px;">-1 Salida</button>
                    </div>
                `;
            });
        });

        function reduceStock(key, current) {
            if(current > 0) db.ref('inventory/' + key + '/qty').set(current - 1);
        }

        function closeModals(e) {
            if(e.target.className === 'modal-overlay') {
                document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
            }
        }
    </script>
</body>
</html>
