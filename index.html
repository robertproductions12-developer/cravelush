<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crave Lush | Sabor que Seduce</title>
    
    <!-- Librer√≠as -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --purple: #6f2c91;
            --yellow: #ffb800;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.2);
            --transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; }

        /* --- FONDO ANIMADO --- */
        body { 
            background: linear-gradient(-45deg, #6f2c91, #ffb800, #4a1a63, #e6a600);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #333; 
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- ELEMENTOS 3D FLOTANTES --- */
        .bg-icons {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1; overflow: hidden;
        }
        .floating-cone {
            position: absolute; color: rgba(255,255,255,0.2);
            font-size: 3rem; animation: float 10s infinite linear;
        }
        @keyframes float {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        /* --- HEADER --- */
        header.main-nav {
            position: fixed; top: 0; width: 100%;
            background: rgba(111, 44, 145, 0.85);
            backdrop-filter: blur(10px);
            padding: 12px 5%;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 2000; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .logo-container { display: flex; align-items: center; gap: 10px; }
        #app-logo { height: 50px; width: auto; border-radius: 8px; object-fit: contain; }
        .logo h2 { color: var(--yellow); font-size: 1.2rem; }

        .btn-nav {
            background: var(--yellow); color: var(--purple);
            border: none; padding: 10px 18px; border-radius: 50px;
            font-weight: 700; cursor: pointer; transition: var(--transition);
            display: flex; align-items: center; gap: 8px;
        }
        .btn-nav:hover { transform: translateY(-3px); background: white; box-shadow: var(--shadow); }

        /* --- SECCIONES --- */
        .section { display: none; padding: 30px 5%; max-width: 1200px; margin: 100px auto 0; animation: slideUp 0.6s ease; }
        .section.active { display: block; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .admin-box { background: rgba(255,255,255,0.95); padding: 25px; border-radius: 20px; margin-bottom: 20px; box-shadow: var(--shadow); }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #eee; border-radius: 12px; outline: none; }

        /* --- BOTONES DE CONTORNO (PROFESIONALES) --- */
        .contour-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin: 15px 0; }
        .btn-contour {
            padding: 10px; border: 2px solid var(--purple); border-radius: 15px;
            background: transparent; color: var(--purple); font-weight: bold;
            cursor: pointer; transition: 0.3s; text-align: center;
        }
        .btn-contour.active { background: var(--purple); color: white; transform: scale(1.05); }

        /* --- TABLAS --- */
        .inv-table { width: 100%; border-collapse: collapse; }
        .inv-table th, .inv-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .stock-low { color: #ff0000; font-weight: bold; background: rgba(255,0,0,0.1); border-radius: 5px; }

        #cart-btn {
            position: fixed; bottom: 25px; right: 25px;
            background: var(--yellow); color: var(--purple);
            width: 65px; height: 65px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; cursor: pointer; z-index: 1500; box-shadow: var(--shadow);
        }

        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .card { background: white; border-radius: 25px; overflow: hidden; transition: var(--transition); }
        .card img { width: 100%; height: 200px; object-fit: cover; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 5000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content { background: white; padding: 30px; border-radius: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }

        footer { background: rgba(0,0,0,0.8); color: white; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <!-- Iconos de fondo -->
    <div class="bg-icons" id="bg-icons"></div>

    <header class="main-nav">
        <div class="logo-container">
            <img id="app-logo" src="https://cdn-icons-png.flaticon.com/512/938/938063.png" alt="Logo">
            <div class="logo"><h2>CRAVE <span>LUSH</span></h2></div>
        </div>
        <div class="nav-links">
            <button class="btn-nav" onclick="switchView('view-menu')"><i class="fas fa-ice-cream"></i> <span>MEN√ö</span></button>
            <button class="btn-nav" onclick="checkAccess('kitchen')"><i class="fas fa-fire"></i> <span>COCINA</span></button>
            <button class="btn-nav" onclick="checkAccess('admin')"><i class="fas fa-user-shield"></i> <span>ADMIN</span></button>
        </div>
    </header>

    <main>
        <!-- SECCI√ìN MEN√ö -->
        <section id="view-menu" class="section active">
            <div id="menu-container" class="menu-grid"></div>
        </section>

        <!-- SECCI√ìN COCINA -->
        <section id="view-kitchen" class="section">
            <h2 style="text-align:center; color:white; margin-bottom:20px;">ORDENES üî•</h2>
            <div id="kitchen-orders"></div>
            
            <div class="admin-box">
                <h4>üì¶ SALIDA DE MATERIALES</h4>
                <div id="kitchen-inventory-list"></div>
            </div>
        </section>

        <!-- SECCI√ìN ADMIN -->
        <section id="view-admin" class="section">
            <div class="admin-box">
                <h4>‚öôÔ∏è Configuraci√≥n & Gastos</h4>
                <button class="btn-nav" onclick="exportExpenses()" style="width:100%; justify-content:center; margin-bottom:10px; background: #28a745; color:white;">
                    <i class="fas fa-file-excel"></i> DESCARGAR REPORTE DE GASTOS (EXCEL)
                </button>
                <input type="file" id="admin-logo-upload" onchange="uploadLogo(this)">
                <input type="text" id="admin-map-link" placeholder="Link Google Maps">
                <button class="btn-nav" onclick="saveSettings()">Guardar Configuraci√≥n</button>
            </div>

            <div class="admin-box">
                <h4>üì¶ CONTROL DE INVENTARIO (ADMIN)</h4>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="inv-name" placeholder="Material">
                    <input type="number" id="inv-qty" placeholder="Cant.">
                    <input type="number" id="inv-cost" placeholder="Costo total ($)">
                </div>
                <button class="btn-nav" style="width:100%; justify-content:center;" onclick="addInventory()">A√ëADIR MATERIAL / GASTO</button>
                <div style="overflow-x: auto; margin-top:15px;">
                    <table class="inv-table" id="admin-inventory-table">
                        <thead><tr><th>Material</th><th>Cant.</th><th>Costo</th><th>Acciones</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="admin-box">
                <h4>üçî Cargar Producto</h4>
                <input type="text" id="prod-name" placeholder="Nombre">
                <input type="number" id="prod-price" placeholder="Precio ($)">
                <input type="text" id="prod-contours" placeholder="Contornos (ej: Fresa, Chocolate, Coco)">
                <input type="file" id="prod-img">
                <button class="btn-nav" onclick="uploadProduct()">GUARDAR PRODUCTO</button>
            </div>
        </section>

        <!-- LOGIN -->
        <section id="view-login" class="section">
            <div class="modal-content" style="margin:auto; text-align:center;">
                <h3 id="login-label">ACCESO</h3>
                <input type="password" id="pass-input" placeholder="Clave">
                <button class="btn-nav" style="width:100%; justify-content:center;" onclick="login()">ENTRAR</button>
            </div>
        </section>
    </main>

    <!-- MODAL PRODUCTO -->
    <div id="product-modal" class="modal-overlay" onclick="closeModals(event)">
        <div class="modal-content">
            <h3 id="modal-prod-name" style="color:var(--purple); font-size:1.8rem;"></h3>
            <p style="margin:10px 0; font-weight:bold;">Selecciona tu contorno favorito:</p>
            <div id="contour-container" class="contour-grid"></div>
            <button class="btn-nav" style="width:100%; justify-content:center; margin-top:20px; font-size:1.1rem;" onclick="confirmAddToCart()">A√ëADIR AL CARRITO üç¶</button>
        </div>
    </div>

    <!-- MODAL CARRITO -->
    <div id="cart-modal" class="modal-overlay" onclick="closeModals(event)">
        <div class="modal-content">
            <h3>üõí Tu Pedido</h3>
            <div id="cart-list"></div>
            <hr>
            <h4>Total: $<span id="cart-total">0.00</span></h4>
            <select id="client-pay-method">
                <option value="Efectivo">Efectivo</option>
                <option value="Pago M√≥vil">Pago M√≥vil</option>
                <option value="Transferencia">Transferencia</option>
            </select>
            <input type="text" id="client-name" placeholder="Tu nombre">
            <button class="btn-nav" style="width:100%; justify-content:center;" onclick="sendOrder()">CONFIRMAR PEDIDO</button>
        </div>
    </div>

    <div id="cart-btn" onclick="openCart()">
        <i class="fas fa-shopping-basket"></i>
        <span id="cart-count" style="position:absolute; top:0; right:0; background:red; color:white; border-radius:50%; width:20px; height:20px; font-size:0.7rem; display:flex; align-items:center; justify-content:center;">0</span>
    </div>

    <script>
        // CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDrNGtxwj0sijnq_vBCTyiRVLO28_D9JG0",
            authDomain: "cravelush-e3277.firebaseapp.com",
            projectId: "cravelush-e3277",
            databaseURL: "https://cravelush-e3277-default-rtdb.firebaseio.com",
            storageBucket: "cravelush-e3277.appspot.com",
            appId: "1:306682994312:web:c7b4e4c7911b2ccaaa493d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let cart = [];
        let selectedProduct = null;
        let selectedContour = "Ninguno";

        // GENERAR HELADOS FLOTANTES
        function createFloatingIcons() {
            const container = document.getElementById('bg-icons');
            const icons = ['fa-ice-cream', 'fa-cookie', 'fa-snowflakes'];
            for(let i=0; i<15; i++) {
                const el = document.createElement('i');
                el.className = `fas ${icons[Math.floor(Math.random()*icons.length)]} floating-cone`;
                el.style.left = Math.random() * 100 + 'vw';
                el.style.animationDelay = Math.random() * 10 + 's';
                el.style.fontSize = (Math.random() * 2 + 1) + 'rem';
                container.appendChild(el);
            }
        }
        createFloatingIcons();

        // NAVEGACI√ìN
        function switchView(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        }

        function checkAccess(role) {
            const pass = prompt("Ingrese clave para " + role);
            const keys = { admin: "1234", kitchen: "5555" };
            if(pass === keys[role]) switchView('view-' + role);
            else if(pass !== null) alert("Clave incorrecta");
        }

        // INVENTARIO Y GASTOS
        function addInventory() {
            const name = document.getElementById('inv-name').value;
            const qty = parseFloat(document.getElementById('inv-qty').value);
            const cost = parseFloat(document.getElementById('inv-cost').value) || 0;
            if(!name || isNaN(qty)) return;

            db.ref('inventory').push({ name, qty, cost, date: new Date().toLocaleDateString() });
            document.getElementById('inv-name').value = "";
            document.getElementById('inv-qty').value = "";
            document.getElementById('inv-cost').value = "";
        }

        db.ref('inventory').on('value', snap => {
            const adminTbody = document.querySelector('#admin-inventory-table tbody');
            const kitchenDiv = document.getElementById('kitchen-inventory-list');
            adminTbody.innerHTML = "";
            kitchenDiv.innerHTML = "";

            snap.forEach(child => {
                const item = child.val();
                const isLow = item.qty < 5;
                const statusClass = isLow ? 'stock-low' : '';

                // Vista Admin
                adminTbody.innerHTML += `
                    <tr>
                        <td class="${statusClass}">${item.name}</td>
                        <td class="${statusClass}">${item.qty}</td>
                        <td>$${item.cost}</td>
                        <td>
                            <button onclick="updateStock('${child.key}', 1)">+</button>
                            <button onclick="updateStock('${child.key}', -1)">-</button>
                        </td>
                    </tr>
                `;

                // Vista Cocina (Solo Salida)
                kitchenDiv.innerHTML += `
                    <div class="admin-box" style="display:flex; justify-content:space-between; align-items:center; padding:10px;">
                        <span class="${statusClass}">${item.name} (Quedan: ${item.qty})</span>
                        <button class="btn-nav" style="padding:5px 15px; background:var(--purple); color:white;" onclick="updateStock('${child.key}', -1)">REBAJAR SALIDA -1</button>
                    </div>
                `;
            });
        });

        function updateStock(key, amt) {
            db.ref(`inventory/${key}/qty`).transaction(c => (c || 0) + amt);
        }

        // REPORTE EXCEL (CSV)
        function exportExpenses() {
            db.ref('inventory').once('value', snap => {
                let csv = "Fecha,Material,Cantidad,Costo Total\n";
                snap.forEach(child => {
                    const i = child.val();
                    csv += `${i.date},${i.name},${i.qty},${i.cost}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('href', url);
                a.setAttribute('download', `Gastos_CraveLush_${new Date().toLocaleDateString()}.csv`);
                a.click();
            });
        }

        // PRODUCTOS
        function uploadProduct() {
            const name = document.getElementById('prod-name').value;
            const price = parseFloat(document.getElementById('prod-price').value);
            const contours = document.getElementById('prod-contours').value;
            const file = document.getElementById('prod-img').files[0];
            if(!name || !file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                db.ref('products').push({ name, price, contours, img: e.target.result });
                alert("Producto Guardado");
            };
            reader.readAsDataURL(file);
        }

        db.ref('products').on('value', snap => {
            const container = document.getElementById('menu-container');
            container.innerHTML = "";
            snap.forEach(child => {
                const p = child.val();
                container.innerHTML += `
                    <div class="card">
                        <img src="${p.img}">
                        <div style="padding:15px; text-align:center;">
                            <h3>${p.name}</h3>
                            <p style="color:var(--purple); font-weight:bold; font-size:1.2rem;">$${p.price.toFixed(2)}</p>
                            <button class="btn-nav" style="width:100%; justify-content:center; margin-top:10px;" 
                                onclick="openProductDetail('${p.name}', ${p.price}, '${p.contours}')">PEDIR</button>
                        </div>
                    </div>
                `;
            });
        });

        function openProductDetail(name, price, contours) {
            selectedProduct = { name, price };
            selectedContour = "Ninguno";
            document.getElementById('modal-prod-name').innerText = name;
            const container = document.getElementById('contour-container');
            container.innerHTML = `<button class="btn-contour active" onclick="selectContour(this, 'Ninguno')">B√°sico</button>`;
            
            if(contours) {
                contours.split(',').forEach(c => {
                    const label = c.trim();
                    container.innerHTML += `<button class="btn-contour" onclick="selectContour(this, '${label}')">${label}</button>`;
                });
            }
            document.getElementById('product-modal').style.display = 'flex';
        }

        function selectContour(btn, val) {
            document.querySelectorAll('.btn-contour').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedContour = val;
        }

        function confirmAddToCart() {
            cart.push({ ...selectedProduct, contour: selectedContour });
            document.getElementById('cart-count').innerText = cart.length;
            document.getElementById('product-modal').style.display = 'none';
            // Efecto de fluidez al a√±adir
            const btn = document.getElementById('cart-btn');
            btn.style.transform = 'scale(1.3)';
            setTimeout(() => btn.style.transform = 'scale(1)', 200);
        }

        // CARRITO & ORDENES
        function openCart() {
            if(cart.length === 0) return alert("Carrito vac√≠o");
            const list = document.getElementById('cart-list');
            let total = 0;
            list.innerHTML = "";
            cart.forEach(item => {
                total += item.price;
                list.innerHTML += `<div style="display:flex; justify-content:space-between; margin:5px 0;">
                    <span>${item.name} (${item.contour})</span> <span>$${item.price.toFixed(2)}</span>
                </div>`;
            });
            document.getElementById('cart-total').innerText = total.toFixed(2);
            document.getElementById('cart-modal').style.display = 'flex';
        }

        function sendOrder() {
            const name = document.getElementById('client-name').value;
            if(!name) return alert("Escribe tu nombre");
            const order = {
                client: name,
                items: cart.map(i => `${i.name} [${i.contour}]`).join(", "),
                total: document.getElementById('cart-total').innerText,
                method: document.getElementById('client-pay-method').value,
                time: new Date().toLocaleTimeString()
            };
            db.ref('orders').push(order);
            alert("¬°Pedido enviado con √©xito!");
            cart = [];
            document.getElementById('cart-count').innerText = "0";
            document.getElementById('cart-modal').style.display = 'none';
        }

        db.ref('orders').on('value', snap => {
            const container = document.getElementById('kitchen-orders');
            container.innerHTML = "";
            snap.forEach(child => {
                const o = child.val();
                container.innerHTML += `
                    <div class="admin-box" style="border-left: 10px solid var(--yellow);">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>${o.client}</strong> <span>${o.method}</span>
                        </div>
                        <p style="margin:10px 0;">${o.items}</p>
                        <button class="btn-nav" style="width:100%; justify-content:center;" onclick="db.ref('orders/${child.key}').remove()">DESPACHAR ‚úÖ</button>
                    </div>
                `;
            });
        });

        function closeModals(e) {
            if(e.target.classList.contains('modal-overlay')) {
                document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
            }
        }
    </script>
</body>
</html>
